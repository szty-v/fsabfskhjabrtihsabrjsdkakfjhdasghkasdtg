-- EXECÃ˜ Loader Guard (Merged)
local EXEC0_GAME = "the abyss"
if getgenv().EXEC0_LOADER and type(getgenv().EXEC0_TOKEN) ~= "string" then
    return
end
getgenv().EXEC0_GAME_LOADED = getgenv().EXEC0_GAME_LOADED or {}
if getgenv().EXEC0_GAME_LOADED[EXEC0_GAME] then
    return
end
getgenv().EXEC0_GAME_LOADED[EXEC0_GAME] = true

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer

local g = _G
g.AB_AutoFish = g.AB_AutoFish or false
g.AB_AutoFarm = g.AB_AutoFarm or false
g.AB_EquipRuinedRequested = g.AB_EquipRuinedRequested or false
g.AB_EquipBathRequested = g.AB_EquipBathRequested or false
g.AB_EquipDeveloperRequested = g.AB_EquipDeveloperRequested or false
g.AB_ChargeOxygenRequested = g.AB_ChargeOxygenRequested or false
g.AB_TPRequested = g.AB_TPRequested or nil
g.AB_SelectedGun = g.AB_SelectedGun or nil
g.AB_SelectedTube = g.AB_SelectedTube or nil
g.AB_TPSpeed = g.AB_TPSpeed or 300
g.AB_ESPChests = g.AB_ESPChests or false
g.AB_ESPFish = g.AB_ESPFish or false
g.AB_InstaFish = g.AB_InstaFish or false
g.AB_SelectedChestTier = g.AB_SelectedChestTier or "Tier1"
g.AB_ChestTPRequested = g.AB_ChestTPRequested or false

local function getKnitServices()
    local services = ReplicatedStorage:WaitForChild("common")
        :WaitForChild("packages")
        :WaitForChild("Knit")
        :WaitForChild("Services")
    return services
end

local function getInventoryEquip()
    local services = getKnitServices()
    return services:WaitForChild("InventoryService")
        :WaitForChild("RF")
        :WaitForChild("EquipItem")
end

local function getHarpoonStart()
    local services = getKnitServices()
    return services:WaitForChild("HarpoonService")
        :WaitForChild("RF")
        :WaitForChild("StartCatching")
end

local function getFishContainer()
    local gameFolder = workspace:FindFirstChild("Game")
    local fish = gameFolder and gameFolder:FindFirstChild("Fish")
    return fish and fish:FindFirstChild("client")
end

local function getChestTierFolder()
    local gameFolder = workspace:FindFirstChild("Game")
    local chests = gameFolder and gameFolder:FindFirstChild("Chests")
    local tierName = g.AB_SelectedChestTier or "Tier1"
    return chests and chests:FindFirstChild(tierName)
end

local function getHRP()
    local character = player.Character
    return character and character:FindFirstChild("HumanoidRootPart")
end

local function nearestFish(pos, container)
    local best, bestDist
    for _, inst in ipairs(container:GetChildren()) do
        if inst:IsA("BasePart") then
            local d = (inst.Position - pos).Magnitude
            if not bestDist or d < bestDist then
                bestDist = d
                best = inst
            end
        end
    end
    return best
end

local function stepMove(hrp, targetPos, step)
    local delta = targetPos - hrp.Position
    local dist = delta.Magnitude
    if dist <= 0 then return end
    local unit = delta.Unit
    local move = math.min(step, dist)
    hrp.CFrame = CFrame.new((hrp.Position + unit * move) + Vector3.new(0, 5, 0))
end

local function setNoClip(enabled)
    local character = player.Character
    if not character then return end
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = not enabled
        end
    end
end

local function tweenToCFrame(cf, duration)
    local hrp = getHRP()
    if not hrp then return end
    local tween = TweenService:Create(
        hrp,
        TweenInfo.new(duration, Enum.EasingStyle.Linear, Enum.EasingDirection.Out, 0, false, 0),
        { CFrame = cf }
    )
    tween:Play()
end

local function tweenToPosition(pos)
    local hrp = getHRP()
    if not hrp then return end
    local speed = tonumber(g.AB_TPSpeed) or 300
    if speed < 50 then speed = 50 end
    if speed > 1000 then speed = 1000 end
    local dist = (pos - hrp.Position).Magnitude
    local duration = dist / speed
    setNoClip(true)
    tweenToCFrame(CFrame.new(pos), duration)
    task.delay(math.max(0.2, duration + 0.2), function()
        setNoClip(false)
    end)
end

-- Auto fish hook (best-effort)
task.spawn(function()
    local startCatching = nil
    while true do
        if g.AB_AutoFish then
            if not startCatching then
                pcall(function()
                    startCatching = getHarpoonStart()
                end)
            end
            if startCatching then
                pcall(function()
                    startCatching:InvokeServer()
                end)
            end
            task.wait(0.5)
        else
            task.wait(0.25)
        end
    end
end)

-- Insta fish (namecall hook)
task.spawn(function()
    local hooked = false
    while true do
        if g.AB_InstaFish and not hooked then
            hooked = true
            local oldNamecall
            oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
                local args = {...}
                if getnamecallmethod() == "InvokeServer" then
                    if tostring(self) == "Update" then
                        if args[2] and type(args[2]) == "table" then
                            args[2].progress = 1
                            if args[2].rewards then
                                for _, reward in pairs(args[2].rewards) do
                                    if type(reward) == "table" then
                                        reward.progress = 1
                                    end
                                end
                            end
                        end
                    end
                end
                return oldNamecall(self, unpack(args))
            end)
        end
        task.wait(0.5)
    end
end)

-- Equip / Charge handlers
task.spawn(function()
    local lastGun = nil
    local lastTube = nil
    while true do
        if g.AB_SelectedGun and g.AB_SelectedGun ~= lastGun then
            lastGun = g.AB_SelectedGun
            pcall(function()
                getInventoryEquip():InvokeServer("guns", g.AB_SelectedGun)
            end)
        end
        if g.AB_SelectedTube and g.AB_SelectedTube ~= lastTube then
            lastTube = g.AB_SelectedTube
            pcall(function()
                getInventoryEquip():InvokeServer("tubes", g.AB_SelectedTube)
            end)
        end
        if g.AB_EquipRuinedRequested then
            g.AB_EquipRuinedRequested = false
            pcall(function()
                getInventoryEquip():InvokeServer("guns", "Ruined")
            end)
        end
        if g.AB_EquipBathRequested then
            g.AB_EquipBathRequested = false
            pcall(function()
                getInventoryEquip():InvokeServer("tubes", "Bath")
            end)
        end
        if g.AB_EquipDeveloperRequested then
            g.AB_EquipDeveloperRequested = false
            pcall(function()
                getInventoryEquip():InvokeServer("guns", "Developer")
            end)
        end
        if g.AB_ChargeOxygenRequested then
            g.AB_ChargeOxygenRequested = false
            local hrp = getHRP()
            if hrp then
                hrp.CFrame = (CFrame.new(0.715997338, 4882.70703, -66.3383942, -1, 0, 0, 0, 1, 0, 0, 0, -1) + Vector3.new(0, 5, 0))
            end
        end
        if g.AB_TPRequested then
            local target = g.AB_TPRequested
            g.AB_TPRequested = nil
            if target == "Spirit Roots" then
                tweenToPosition(Vector3.new(2100.965, 4243.479, -2153.958))
            elseif target == "Ancient Sands" then
                tweenToPosition(Vector3.new(-1597.1431884765625, 4554.76220703125, -32.60858154296875))
            elseif target == "Forgotten Deep" then
                tweenToPosition(Vector3.new(0.72, 4882.71, -66.34))
            end
        end
        task.wait(0.1)
    end
end)

-- Chest TP runner
task.spawn(function()
    while true do
        if g.AB_ChestTPRequested then
            g.AB_ChestTPRequested = false
            local tierFolder = getChestTierFolder()
            local hrp = getHRP()
            if tierFolder and hrp then
                setNoClip(true)
                for _, chest in ipairs(tierFolder:GetChildren()) do
                    local prompt = chest:FindFirstChild("Chest", true)
                        and chest.Chest:FindFirstChild("Main", true)
                        and chest.Chest.Main:FindFirstChild("BottomChest", true)
                        and chest.Chest.Main.BottomChest:FindFirstChild("RewardPart", true)
                        and chest.Chest.Main.BottomChest.RewardPart:FindFirstChild("Prompt")
                    if prompt and prompt.Parent and prompt.Parent:IsA("BasePart") then
                        local targetPos = prompt.Parent.Position
                        tweenToPosition(targetPos)
                        task.wait(0.5)
                        pcall(function()
                            fireproximityprompt(prompt)
                        end)
                        task.wait(0.2)
                    end
                end
                setNoClip(false)
            end
        end
        task.wait(0.2)
    end
end)

-- ESP
getgenv().ESP_Table = getgenv().ESP_Table or {
    ChestConnections = {},
    FishConnections = {},
    CreatedUI = {}
}

local tierColors = {
    ["Tier 1"] = Color3.fromRGB(0, 255, 0),
    ["Tier 2"] = Color3.fromRGB(255, 255, 0),
    ["Tier 3"] = Color3.fromRGB(255, 0, 0)
}

local function clearESP(kind)
    if kind == "FISH" then
        for _, conn in pairs(getgenv().ESP_Table.FishConnections) do conn:Disconnect() end
        getgenv().ESP_Table.FishConnections = {}
    elseif kind == "CHEST" then
        for _, conn in pairs(getgenv().ESP_Table.ChestConnections) do conn:Disconnect() end
        getgenv().ESP_Table.ChestConnections = {}
    end

    for obj, ui in pairs(getgenv().ESP_Table.CreatedUI) do
        if ui and ui.Parent and ui.Name == (kind == "FISH" and "FISH_UI" or "CHEST_UI") then
            ui:Destroy()
            getgenv().ESP_Table.CreatedUI[obj] = nil
        end
    end
end

local function createESP(obj, text, subtext, color, uiName)
    if not obj or getgenv().ESP_Table.CreatedUI[obj] then return end

    local bbg = Instance.new("BillboardGui")
    bbg.Name = uiName
    bbg.Size = UDim2.new(0, 150, 0, 50)
    bbg.StudsOffset = Vector3.new(0, 3, 0)
    bbg.AlwaysOnTop = true
    bbg.Parent = obj

    local label = Instance.new("TextLabel")
    label.Parent = bbg
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, 0, 1, 0)
    label.RichText = true
    label.Text = string.format("%s\n[%s]", text, subtext)
    label.TextColor3 = color
    label.TextStrokeTransparency = 0
    label.Font = Enum.Font.RobotoMono
    label.TextSize = 14

    getgenv().ESP_Table.CreatedUI[obj] = bbg
end

local function applyFishESP(fish)
    if not fish or not g.AB_ESPFish then return end
    local stat = fish:FindFirstChild("stats", true)
    if stat then
        local name = stat:FindFirstChild("Fish") and stat.Fish.Text or fish.Name
        local mut = stat:FindFirstChild("Mutation") and stat.Mutation:FindFirstChildOfClass("TextLabel")
        local mutation = mut and mut.Text or "Normal"
        local coloredMutation = "<font color='#FFFF00'>" .. mutation .. "</font>"
        createESP(fish, name, coloredMutation, Color3.fromRGB(0, 255, 255), "FISH_UI")
    end
end

task.spawn(function()
    while true do
        local gameWork = workspace:FindFirstChild("Game")
        local chests = gameWork and gameWork:FindFirstChild("Chests")
        local fishes = gameWork and gameWork:FindFirstChild("Fish") and gameWork.Fish:FindFirstChild("client")

        if g.AB_ESPChests then
            clearESP("CHEST")
            if chests then
                for _, folder in pairs(chests:GetChildren()) do
                    for _, chest in pairs(folder:GetChildren()) do
                        createESP(chest, chest.Name, folder.Name, tierColors[folder.Name] or Color3.new(1,1,1), "CHEST_UI")
                    end
                end
            end
        else
            clearESP("CHEST")
        end

        if g.AB_ESPFish then
            clearESP("FISH")
            if fishes then
                for _, fish in pairs(fishes:GetChildren()) do
                    applyFishESP(fish)
                end

                local addConn = fishes.ChildAdded:Connect(function(child)
                    task.wait(0.5)
                    if g.AB_ESPFish then applyFishESP(child) end
                end)
                table.insert(getgenv().ESP_Table.FishConnections, addConn)

                local remConn = fishes.ChildRemoved:Connect(function(child)
                    if getgenv().ESP_Table.CreatedUI[child] then
                        getgenv().ESP_Table.CreatedUI[child]:Destroy()
                        getgenv().ESP_Table.CreatedUI[child] = nil
                    end
                end)
                table.insert(getgenv().ESP_Table.FishConnections, remConn)
            end
        else
            clearESP("FISH")
        end

        task.wait(2)
    end
end)

-- Auto farm (teleport toward nearest fish)
task.spawn(function()
    while true do
        if g.AB_AutoFarm then
            local hrp = getHRP()
            local container = getFishContainer()
            if hrp and container then
                local target = nearestFish(hrp.Position, container)
                if target then
                    for i = 1, 6 do
                        if not g.AB_AutoFarm then break end
                        stepMove(hrp, target.Position, 50)
                        task.wait(0.3)
                    end
                end
            end
            task.wait(0.3)
        else
            task.wait(0.25)
        end
    end
end)
